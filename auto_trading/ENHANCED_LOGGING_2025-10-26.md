# 강화된 로깅 시스템 (2025-10-26)

## 🎯 개선 사항

사용자 요청사항에 따라 다음 기능들을 추가했습니다:

### 1. ✅ 잔액 조회 결과 상세 표시

**이전**:
```
ERROR | 잔고 조회 실패: -202
```
- 실제로 조회가 되었는지 알 수 없음
- 성공 시 결과가 표시되지 않음

**현재**:
```
SUCCESS | ✅ 잔고 조회 성공
INFO    |    💰 예수금: 10,000,000원
INFO    |    📊 총평가: 10,750,000원
INFO    |    📈 총손익: +750,000원
```
또는 실패 시:
```
ERROR   | ❌ 잔고 조회 실패: -202
ERROR   |    에러 코드 -202: 조회 과부하 (잠시 후 재시도)
```

### 2. ✅ 보유 종목 상세 정보 표시

**이전**:
```
ERROR | 보유종목 조회 실패: -202
```

**현재**:
```
SUCCESS | ✅ 보유종목 조회 성공: 3개
INFO    |    📊 삼성전자(005930): 10주 @ 75,000원 → 76,500원 (+2.00%)
INFO    |    📊 SK하이닉스(000660): 5주 @ 120,000원 → 118,000원 (-1.67%)
INFO    |    📊 카카오(035720): 15주 @ 50,000원 → 52,000원 (+4.00%)
```

### 3. ✅ 실시간 가격 업데이트 표시

**새로운 기능**:
- 관심 종목의 실시간 가격을 주기적으로 표시 (10번째 업데이트마다)
- 변동률과 수신된 데이터 개수도 함께 표시

```
INFO | 📊 실시간: 005930 76,500원 (+2.00%) | 데이터: 50개
INFO | 📊 실시간: 000660 118,000원 (-1.67%) | 데이터: 50개
INFO | 📊 실시간: 035720 52,000원 (+4.00%) | 데이터: 50개
```

### 4. ✅ 급등주 모니터링 상태 명확화

**프로그램 시작 시**:
```
SUCCESS | 🚀 급등주 모니터링 시작!
INFO    |    📋 후보군: 100개 종목
INFO    |    📊 조건: 상승률 >= 5.0%, 거래량 >= 2.0배
INFO    |    • 삼성전자(005930)
INFO    |    • SK하이닉스(000660)
INFO    |    • NAVER(035420)
INFO    |    • 카카오(035720)
INFO    |    • 현대차(005380)
INFO    |    ... 외 95개
```

**5분마다 상태 요약**:
```
======================================================================
📊 자동매매 상태 요약
======================================================================
INFO | 👀 관심 종목: 3개 - 005930, 000660, 035720
INFO | 📡 가격 데이터: 150개 수신
INFO |    005930: 50개
INFO |    000660: 50개
INFO |    035720: 50개
INFO | 📭 보유 포지션 없음
INFO | 🚀 급등주 모니터링: 활성 ✅
INFO |    후보군: 100개
INFO |    감지됨: 3개
INFO |    추가됨: 2개
INFO | 📊 매매 신호 생성: 5회
======================================================================
```

### 5. ✅ 데이터 수신 확인

**가격 데이터 수신 없음 경고**:
```
WARNING | ⚠️  가격 데이터 수신 없음 - 실시간 등록 확인 필요
```

이제 데이터가 실제로 수신되고 있는지 명확히 알 수 있습니다!

## 📊 수정된 파일

### 1. `kiwoom_api.py`
**변경 사항**:
- `get_balance()`: 조회 성공 시 상세 정보 로깅
- `get_holdings()`: 보유 종목 상세 정보 로깅
- 에러 코드 -202 설명 추가

**코드 예시**:
```python
if balance_data:
    log.success(f"✅ 잔고 조회 성공")
    log.info(f"   💰 예수금: {balance_data.get('cash', 0):,}원")
    log.info(f"   📊 총평가: {balance_data.get('total_value', 0):,}원")
    log.info(f"   📈 총손익: {balance_data.get('profit_loss', 0):+,}원")
```

### 2. `trading_engine.py`
**변경 사항**:
- `on_price_update()`: 실시간 가격 표시 추가
- `_periodic_check()`: 5분마다 상태 요약
- `_print_status_summary()`: 상세 상태 출력 함수 추가

**새로운 기능**:
```python
# 실시간 가격 표시 (10번째 업데이트마다)
if len(self.price_history[stock_code]) % 10 == 0:
    log.info(
        f"📊 실시간: {stock_code} {current_price:,}원 "
        f"({change_rate:+.2f}%) | 데이터: {len(self.price_history[stock_code])}개"
    )
```

### 3. `surge_detector.py`
**변경 사항**:
- `start_monitoring()`: 시작 시 상세 정보 표시
- 후보군 샘플 출력 (처음 5개)

## 🚀 사용 방법

### 프로그램 실행
```powershell
cd auto_trading
python main.py
```

### 로그 실시간 모니터링
```powershell
# 거래 로그
Get-Content logs\trading_2025-10-26.log -Wait -Tail 30

# 에러 로그
Get-Content logs\error_2025-10-26.log -Wait -Tail 20
```

## 📝 예상 로그 출력

### 프로그램 시작
```
2025-10-26 09:00:00 | INFO     | 프로그램 시작...
2025-10-26 09:00:05 | SUCCESS  | ✅ 로그인 성공!
2025-10-26 09:00:05 | INFO     | 자동매매 엔진 초기화 중...
2025-10-26 09:00:08 | SUCCESS  | ✅ 잔고 조회 성공
2025-10-26 09:00:08 | INFO     |    💰 예수금: 10,000,000원
2025-10-26 09:00:08 | INFO     |    📊 총평가: 10,000,000원
2025-10-26 09:00:08 | INFO     |    📈 총손익: 0원
2025-10-26 09:00:10 | INFO     | 📭 보유종목 없음 (초기 상태)
2025-10-26 09:00:10 | SUCCESS  | ✅ 엔진 초기화 완료!
2025-10-26 09:00:15 | SUCCESS  | 🚀 자동매매 시작!
2025-10-26 09:00:15 | INFO     |    관심 종목: 005930, 000660, 035720
2025-10-26 09:00:15 | SUCCESS  | 🚀 급등주 모니터링 시작!
2025-10-26 09:00:15 | INFO     |    📋 후보군: 100개 종목
2025-10-26 09:00:15 | INFO     |    📊 조건: 상승률 >= 5.0%, 거래량 >= 2.0배
```

### 실시간 거래
```
2025-10-26 09:05:00 | INFO     | 📊 실시간: 005930 76,500원 (+2.00%) | 데이터: 10개
2025-10-26 09:10:00 | INFO     | 📊 실시간: 005930 77,000원 (+2.67%) | 데이터: 20개
2025-10-26 09:15:00 | INFO     | 📊 실시간: 005930 77,500원 (+3.33%) | 데이터: 30개
```

### 5분마다 상태 요약
```
2025-10-26 09:05:00 | INFO     | ======================================================================
2025-10-26 09:05:00 | INFO     | 📊 자동매매 상태 요약
2025-10-26 09:05:00 | INFO     | ======================================================================
2025-10-26 09:05:00 | INFO     | 👀 관심 종목: 3개 - 005930, 000660, 035720
2025-10-26 09:05:00 | INFO     | 📡 가격 데이터: 150개 수신
2025-10-26 09:05:00 | INFO     |    005930: 50개
2025-10-26 09:05:00 | INFO     |    000660: 50개
2025-10-26 09:05:00 | INFO     |    035720: 50개
2025-10-26 09:05:00 | INFO     | 📭 보유 포지션 없음
2025-10-26 09:05:00 | INFO     | 🚀 급등주 모니터링: 활성 ✅
2025-10-26 09:05:00 | INFO     |    후보군: 100개
2025-10-26 09:05:00 | INFO     |    감지됨: 0개
2025-10-26 09:05:00 | INFO     |    추가됨: 0개
2025-10-26 09:05:00 | INFO     | 📊 매매 신호 생성: 0회
2025-10-26 09:05:00 | INFO     | ======================================================================
```

## ⚠️ 에러 코드 -202 해결

### 원인
- API 조회 과부하
- 너무 빠른 연속 조회
- 일일 조회 한도 초과

### 해결 방법

**1. 대기 시간 증가** (이미 적용됨):
```python
# kiwoom_api.py
def _wait_for_request(self):
    time.sleep(0.25)  # 0.2초 → 0.25초로 증가
```

**2. 재시도 로직 추가** (향후 개선):
```python
# 최대 3회 재시도
for attempt in range(3):
    result = self.get_balance()
    if result:
        break
    time.sleep(1)  # 1초 대기 후 재시도
```

**3. 로그인 후 대기**:
```python
# main.py 또는 trading_engine.py
time.sleep(5)  # 로그인 후 5초 대기
```

## 🔍 문제 진단

### 로그가 업데이트되지 않을 때

**1. 프로그램이 실제로 실행 중인지 확인**:
```powershell
tasklist | findstr python
```

**2. 최신 로그 파일 확인**:
```powershell
Get-ChildItem logs\*.log | Sort-Object LastWriteTime -Descending | Select-Object -First 5
```

**3. 로그 파일 권한 확인**:
```powershell
icacls logs
```

### 데이터 수신이 없을 때

**확인 사항**:
- [ ] 장 운영 시간인지 확인 (09:00 ~ 15:30)
- [ ] 실시간 등록이 성공했는지 로그 확인
- [ ] 키움 API 연결 상태 확인

**로그에서 확인**:
```
SUCCESS | 실시간 시세 등록 완료: 3개 종목
```

이 메시지가 없으면 실시간 등록 실패!

## 📈 개선 효과

### 투명성
- ✅ 모든 조회 결과를 명확히 표시
- ✅ 성공/실패 여부 즉시 확인
- ✅ 에러 원인 설명 추가

### 모니터링
- ✅ 실시간 가격 업데이트 확인
- ✅ 데이터 수신 상태 확인
- ✅ 급등주 모니터링 상태 확인

### 디버깅
- ✅ 문제 발생 시 즉시 파악
- ✅ 상세한 로그로 원인 분석
- ✅ 5분마다 상태 요약

## 🎉 결과

이제 프로그램이:
- ✅ 실제로 조회가 되는지 명확히 표시
- ✅ 등록된 주식 종목의 가격도 실시간 표시
- ✅ 급등주 조회 상황 상세히 표시
- ✅ 모든 활동이 로그에 상세히 기록

**프로그램 실행 후 로그를 확인해보세요!** 🚀

---

**작성**: CleonAI 개발팀  
**날짜**: 2025-10-26  
**버전**: v1.2  
**상태**: ✅ 완료

