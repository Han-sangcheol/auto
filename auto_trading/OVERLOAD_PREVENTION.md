# 키움 API 과부하 방지 규칙

## 📋 **작성일**: 2025-10-27

## 🚨 **문제 상황**

키움 Open API는 **초당 5건의 TR 조회 제한**이 있습니다.
이를 초과하면 `-202 (조회 과부하)` 에러가 발생하고 프로그램이 불안정해집니다.

## ✅ **구현된 과부하 방지 규칙**

### 1️⃣ **API 호출 제한 강화**

#### `kiwoom_api.py` - `_wait_for_request()`

```python
# 이전: 단순 0.2초 간격
self.request_delay = 0.2  # 초당 5건

# 현재: 강력한 제한
API_REQUEST_DELAY = 0.5초     # 최소 간격
API_MAX_PER_SECOND = 2건      # 초당 최대 호출
```

**작동 방식:**
1. **1초 내 요청 이력 추적** (`request_history`)
2. **1초 내 2건 초과 시 자동 대기**
3. **최소 0.5초 간격 보장**
4. **안전 마진 0.1초 추가**

#### 실제 제한:
- 공식 제한: 초당 5건
- 우리 제한: **초당 2건** (안전 마진 150%)

### 2️⃣ **실시간 시세 등록 배치 처리**

#### `kiwoom_api.py` - `register_real_data()`

```python
REAL_DATA_BATCH_SIZE = 50  # 50개씩 분할

# 100개 종목 등록 시:
# → 50개 + 2초 대기 + 50개
```

**과부하 방지:**
- 50개 초과 시 자동 분할
- 배치 간 **2초 대기**
- 각 배치마다 `_wait_for_request()` 호출

### 3️⃣ **급등주 순차 처리**

#### `trading_engine.py` - `add_surge_stock()`

```python
self.surge_processing = False  # 처리 중 플래그

def add_surge_stock():
    if self.surge_processing:
        return  # 이미 처리 중이면 건너뜀
    
    self.surge_processing = True
    try:
        # 1. 종목 추가
        # 2. 실시간 시세 등록 (1초 대기)
        # 3. 매수 주문 시도
    finally:
        self.surge_processing = False
```

**효과:**
- 급등주 **한 번에 하나씩만** 처리
- 동시 API 호출 방지
- 안정적인 순차 처리

### 4️⃣ **최대 보유 종목 수 제한**

```python
MAX_STOCKS = 3  # 기본값

if len(positions) >= MAX_STOCKS:
    log.warning("최대 보유 종목 수 도달 - 추가 불가")
    return
```

**효과:**
- 과도한 포지션 방지
- API 호출 빈도 감소
- 리스크 관리 강화

## 📊 **과부하 방지 효과**

| 항목 | 이전 | 현재 | 개선율 |
|------|------|------|--------|
| API 호출 간격 | 0.2초 | **0.5초** | +150% |
| 초당 최대 호출 | 5건 | **2건** | -60% |
| 실시간 등록 배치 | 100개 | **50개** | -50% |
| 급등주 동시 처리 | 무제한 | **1개씩** | -100% |
| 최대 보유 종목 | 무제한 | **3개** | 제한 |

## ⚙️ **설정 조정 (config.py)**

### **보수적 설정** (권장)
```python
MAX_STOCKS = 3                    # 최대 3개 종목
API_REQUEST_DELAY = 0.5           # 0.5초 간격
API_MAX_PER_SECOND = 2            # 초당 2건
REAL_DATA_BATCH_SIZE = 50         # 50개씩 배치
SURGE_CANDIDATE_COUNT = 100       # 급등주 후보 100개
```

### **균형 설정**
```python
MAX_STOCKS = 5                    # 최대 5개 종목
API_REQUEST_DELAY = 0.3           # 0.3초 간격
API_MAX_PER_SECOND = 3            # 초당 3건
REAL_DATA_BATCH_SIZE = 30         # 30개씩 배치
SURGE_CANDIDATE_COUNT = 50        # 급등주 후보 50개
```

### **공격적 설정** (주의!)
```python
MAX_STOCKS = 10                   # 최대 10개 종목
API_REQUEST_DELAY = 0.25          # 0.25초 간격
API_MAX_PER_SECOND = 4            # 초당 4건
REAL_DATA_BATCH_SIZE = 100        # 100개씩 배치
SURGE_CANDIDATE_COUNT = 200       # 급등주 후보 200개
```

⚠️ **경고**: 공격적 설정은 과부하 위험이 높습니다!

## 🔍 **과부하 모니터링**

### **정상 작동 로그:**
```
✅ 실시간 시세 등록 완료: 50개 종목
✅ 급등주 처리 완료: HJ중공업 (097230)
⏳ 다른 급등주 처리 중 - 대기: 한미사이언스
📊 API 요청 통계: 총 100건
```

### **과부하 경고 로그:**
```
⏳ API 과부하 방지 대기: 0.8초
⚠️  종목 수가 많아 분할 등록: 150개 → 50개씩
⚠️  최대 보유 종목 수 도달 (3/3) - 급등주 추가 불가
```

### **과부하 에러 로그:**
```
❌ 잔고 조회 실패: -202
   에러 코드 -202: 조회 과부하 (잠시 후 재시도)
```

→ **이 에러가 자주 나타나면** 설정을 더 보수적으로 변경!

## 🆘 **과부하 발생 시 대응**

### 1단계: 급등주 후보 수 감소
```env
SURGE_CANDIDATE_COUNT=50  # 100 → 50으로
```

### 2단계: 최대 종목 수 감소
```env
MAX_STOCKS=2  # 3 → 2로
```

### 3단계: 배치 크기 감소
```python
# config.py
REAL_DATA_BATCH_SIZE = 30  # 50 → 30으로
```

### 4단계: API 호출 간격 증가
```python
# config.py
API_REQUEST_DELAY = 1.0  # 0.5 → 1.0초로
```

### 5단계: 프로그램 재시작
```cmd
# Ctrl+C로 종료
start.bat  # 재시작
```

## 📈 **성능 vs 안정성 균형**

```
성능 ←→ 안정성

[공격적]                [보수적]
빠름, 많은 종목          느림, 적은 종목
과부하 위험 높음          과부하 위험 낮음
수익 기회 많음            수익 기회 제한
```

**권장**: 처음에는 **보수적 설정**으로 시작
→ 안정적이면 점진적으로 조정

## ✅ **체크리스트**

프로그램 실행 전:
- [ ] `MAX_STOCKS` 설정 확인 (기본 3개)
- [ ] `SURGE_CANDIDATE_COUNT` 확인 (기본 100개)
- [ ] 과부하 방지 로그 확인
- [ ] 에러 로그에서 `-202` 에러 확인

프로그램 실행 중:
- [ ] "과부하 방지 대기" 메시지 정상 표시
- [ ] 급등주가 순차적으로 처리됨
- [ ] API 요청 통계 정상 증가

과부하 발생 시:
- [ ] 로그에서 `-202` 에러 확인
- [ ] 설정을 더 보수적으로 변경
- [ ] 프로그램 재시작

## 📚 **참고**

- 키움 Open API 공식 제한: 초당 5건
- 실제 안전 제한: **초당 2건** 권장
- 배치 처리: **50개 단위** 권장
- 순차 처리: **필수**

---

**마지막 업데이트**: 2025-10-27
**버전**: 1.0
**상태**: ✅ 적용 완료


