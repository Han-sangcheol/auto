# 🆕 호가 분석 기능 추가 (2025-10-28)

## 📌 문제 인식

### 기존 급등주 감지의 한계

**후행 지표 문제:**
- 이미 가격이 10% 오른 후에 감지 → 고점 매수 위험
- 단순 거래량만 확인 → 매도 물량인지 매수 물량인지 구분 불가
- 늦은 진입으로 인한 수익 기회 감소

**예시:**
```
09:30:00 → 종목 A가 10% 상승
09:30:05 → 급등 감지! (하지만 이미 늦음)
09:30:10 → 매수 체결 (고점 근처)
09:30:30 → 가격 하락 시작 (손실)
```

## 💡 해결책: 호가창 분석

### 호가 데이터란?

호가창에는 현재 매수/매도 대기 중인 주문 정보가 표시됩니다:

```
매도호가  |  수량   |  매수호가  |  수량
--------|---------|-----------|--------
10,500  |  1,000  |           |
10,400  |  2,500  |           |
10,300  |    500  |           |
--------|---------|-----------|--------
        |         |  10,200   |  5,000
        |         |  10,100   |  8,000
        |         |  10,000   |  3,000

매도 총잔량: 4,000주
매수 총잔량: 16,000주
체결강도: 250%
```

**분석 결과:**
- 매수 총잔량이 매도 총잔량의 4배 → 강한 매수세
- 체결강도 250% → 매수 체결이 매도의 2.5배
- **→ 가격 상승 가능성 높음!**

## 🎯 호가 분석 지표

### 1. 매수/매도 잔량 비율

```python
매수/매도 잔량 비율 = 매수 총잔량 / 매도 총잔량

해석:
- 2.0 이상: 매수세 매우 강함 (40점)
- 1.5 ~ 2.0: 매수세 강함 (30점)
- 1.0 ~ 1.5: 매수세 우위 (20점)
- 0.8 ~ 1.0: 균형 (10점)
- 0.8 미만: 매도세 우위 (0점)
```

### 2. 체결강도

```python
체결강도 = (매수 체결량 / 매도 체결량) × 100

해석:
- 200% 이상: 매수 압도적 (40점)
- 150 ~ 200%: 매수 강세 (30점)
- 120 ~ 150%: 매수 우위 (20점)
- 100 ~ 120%: 약간 우위 (10점)
- 100% 미만: 매도 우위 (0점)
```

### 3. 매수 압력 점수 (종합)

```python
매수 압력 점수 = 잔량 비율 점수(40점) + 체결강도 점수(40점) + 상승률 점수(20점)

예시:
- 잔량 비율 2.1 → 40점
- 체결강도 210% → 40점
- 상승률 8% → 20점
----------------------------
총점: 100점 → 매수 시그널 매우 강함!
```

## 🚀 개선된 급등주 감지 로직

### Before (기존)

```python
급등 조건:
1. 상승률 >= 10%  ✓
2. 거래량 >= 평균의 3배 ✓

→ 매수 신호 발생
```

**문제:** 이미 많이 오른 후 + 매도 물량이 많아도 감지됨

### After (개선)

```python
급등 조건:
1. 상승률 >= 10%  ✓
2. 거래량 >= 평균의 3배 ✓
3. 🆕 매수 압력 점수 >= 60점 ✓  ← 호가 분석 추가

→ 매수 신호 발생 (더 정확함!)
```

**개선점:**
- 매수세가 강한 종목만 선별
- 고점 매수 위험 감소
- 선제적 진입 가능

## 📊 실제 동작 예시

### 시나리오 1: 진짜 급등주 (✅ 매수)

```
종목: A전자
시간: 09:30:15

[가격 데이터]
- 상승률: +12% ✓
- 거래량: 평균의 3.5배 ✓

[호가 데이터]
- 매수 총잔량: 50,000주
- 매도 총잔량: 15,000주
- 잔량 비율: 3.33 (매수세 압도적)
- 체결강도: 220%

[매수 압력 점수]
- 잔량 비율: 40점
- 체결강도: 40점
- 상승률: 20점
- 총점: 100점 ✓

→ 🚀 급등 감지! 매수세: 100점 | 잔량비: 3.33 | 체결강도: 220%
→ ✅ 매수 진행
```

### 시나리오 2: 가짜 급등주 (❌ 매수 안 함)

```
종목: B바이오
시간: 09:31:45

[가격 데이터]
- 상승률: +11% ✓
- 거래량: 평균의 4배 ✓

[호가 데이터]
- 매수 총잔량: 10,000주
- 매도 총잔량: 80,000주
- 잔량 비율: 0.125 (매도세 압도적)
- 체결강도: 85% (매도 우위)

[매수 압력 점수]
- 잔량 비율: 0점 (0.125 < 0.8)
- 체결강도: 0점 (85% < 100%)
- 상승률: 15점
- 총점: 15점 ❌

→ ⚠️  조건 미달: 매수세 15점 < 60점 (매도 물량 많음)
→ ❌ 매수하지 않음 (고점 매수 회피)
```

## ⚙️ 설정 방법

### 기본 설정 (권장)

```python
# config.py
SURGE_MIN_BUYING_PRESSURE = 60.0  # 매수 압력 점수 (0~100)

# 60점 이상이면 양호한 매수세
# 낮추면 더 많은 종목 감지 (위험 증가)
# 높이면 더 안전한 종목만 감지 (기회 감소)
```

### 공격적 설정 (더 많은 기회)

```.env
SURGE_MIN_BUYING_PRESSURE=50.0  # 50점 이상
```

**특징:**
- 더 많은 급등주 감지
- 수익 기회 증가
- 고점 매수 위험도 증가

### 보수적 설정 (더 안전하게)

```.env
SURGE_MIN_BUYING_PRESSURE=70.0  # 70점 이상
```

**특징:**
- 매수세가 매우 강한 종목만
- 고점 매수 위험 최소화
- 수익 기회 감소 (하지만 안전함)

## 📈 예상 효과

### 1. 고점 매수 방지

**Before:**
```
10개 급등주 감지 → 10개 모두 매수
→ 3개는 고점 매수로 손실
```

**After:**
```
10개 급등주 감지 → 호가 분석 → 6개만 매수
→ 매도세 강한 4개 제외 (고점 매수 회피)
```

### 2. 수익률 개선

- 진입 타이밍 개선: 선제적 매수 가능
- 손실 종목 감소: 가짜 급등주 필터링
- 전체 수익률 증가: 더 나은 종목 선택

### 3. 실시간 매수세 파악

```
[로그 예시]
📊 호가: 삼성전자(005930) | 매수세: 85점 | 잔량비: 2.15 | 체결강도: 180%
🚀 급등 감지! 삼성전자 (005930) | 상승률: +12.30% | 거래량: 3.20배 | 매수세: 85점
```

## 🔧 기술 구현

### 1. 호가 데이터 수신

```python
# kiwoom_api.py
# FID 추가: 거래량(13), 매도호가총잔량(121), 매수호가총잔량(125), 체결강도(228)
fids = "9001;10;11;12;13;27;28;121;125;228"
```

### 2. 호가 분석

```python
# surge_detector.py
def update_order_book(self, bid_volume: int, ask_volume: int, execution_strength: int):
    """호가 데이터 업데이트"""
    self.bid_volume = bid_volume
    self.ask_volume = ask_volume
    self.execution_strength = execution_strength
    self.bid_ask_ratio = bid_volume / ask_volume  # 잔량 비율

def get_buying_pressure(self) -> float:
    """매수 압력 점수 계산 (0~100)"""
    score = 0
    
    # 잔량 비율 (40점)
    if self.bid_ask_ratio > 2.0:
        score += 40
    elif self.bid_ask_ratio > 1.5:
        score += 30
    # ...
    
    # 체결강도 (40점)
    if self.execution_strength > 200:
        score += 40
    elif self.execution_strength > 150:
        score += 30
    # ...
    
    # 상승률 (20점)
    if self.current_change_rate > 7:
        score += 20
    # ...
    
    return min(score, 100)
```

### 3. 개선된 급등 조건

```python
def is_surge_detected(self, min_change_rate, min_volume_ratio, min_buying_pressure=60.0):
    # 1. 상승률 확인
    if self.current_change_rate < min_change_rate:
        return False
    
    # 2. 거래량 확인
    if self.get_volume_ratio() < min_volume_ratio:
        return False
    
    # 3. 🆕 매수 압력 확인
    if self.bid_volume > 0 or self.ask_volume > 0:
        buying_pressure = self.get_buying_pressure()
        if buying_pressure < min_buying_pressure:
            return False  # 매수세 부족
    
    return True
```

## 📚 관련 문서

- **OVERLOAD_FIX_2025-10-28.md** - 과부하 방지 최적화
- **SURGE_GUIDE.md** - 급등주 감지 전체 가이드
- **config.py** - 설정 파일

## 🎓 호가창 읽는 법

### 호가창 구조

```
매도호가       수량       | 매수호가       수량
(매도 10호가)  xxx       |
(매도 9호가)   xxx       |
    ...                  |
(매도 1호가)   xxx       |
----------------------------
                          | (매수 1호가)   xxx
                          | (매수 2호가)   xxx
                          |     ...
                          | (매수 10호가)  xxx

매도호가총잔량: X,XXX    | 매수호가총잔량: Y,YYY
체결강도: ZZZ%
```

### 매수세가 강한 신호

1. **매수 총잔량 > 매도 총잔량** (2배 이상이면 매우 강함)
2. **체결강도 > 100%** (매수 체결이 더 많음)
3. **매수 1호가 수량이 큼** (큰 손의 매수 의지)

### 매도세가 강한 신호

1. **매도 총잔량 > 매수 총잔량** (2배 이상이면 위험)
2. **체결강도 < 100%** (매도 체결이 더 많음)
3. **매도 1호가 수량이 큼** (큰 물량 매도 대기)

## 🚨 주의사항

### 1. 호가 데이터의 한계

- **순간적 변동**: 호가는 실시간으로 변함
- **조작 가능성**: 큰 손이 의도적으로 호가를 조작할 수 있음
- **체결 전까지는 미확정**: 호가는 예약일 뿐, 실제 체결되지 않을 수 있음

### 2. 다른 지표와 함께 사용

호가 분석만으로는 부족합니다. 함께 확인하세요:
- ✅ 상승률, 거래량 (기본 조건)
- ✅ 뉴스, 이슈 (급등 이유)
- ✅ 차트 패턴 (기술적 분석)
- ✅ 시장 전체 분위기

### 3. 백테스팅 필수

실제 사용 전에:
1. 모의투자로 최소 1주일 테스트
2. 다양한 매수 압력 점수 설정 실험
3. 수익률 통계 확인

## 📊 성능 모니터링

### 로그 확인

```bash
# 호가 데이터 수신 확인 (처음 3번만 표시)
📊 호가: 삼성전자(005930) | 매수세: 75점 | 잔량비: 1.85 | 체결강도: 165%

# 급등 감지 시 호가 정보 포함
🚀 급등 감지! 삼성전자 (005930) | 상승률: +11.20% | 거래량: 3.10배 | 
   매수세: 75점 (잔량비 1.85, 체결강도 165%)
```

### 통계 분석

- 매수 압력 점수별 수익률
- 호가 조건 충족 비율
- 고점 매수 감소율

---

**최종 업데이트**: 2025-10-28
**기능**: ✅ 구현 완료
**상태**: 🧪 테스트 필요
**효과**: 🎯 고점 매수 방지 + 선제적 진입

