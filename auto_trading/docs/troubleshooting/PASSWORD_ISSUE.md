# 계좌 비밀번호 문제 해결 가이드

## 문제 증상

매수 시그널 발생 시 다음과 같은 에러가 발생합니다:

```
❌ 매수 주문 실패 (코드: -301): [종목코드]
```

그리고 다음과 같은 팝업이 나타납니다:

```
계좌확인문은 유효하지 않아 사용이 계좌확인문의 비밀번호를 입력하십시오 (22)
```

## 원인

키움 Open API의 `SendOrder()` 함수는 주문 시 계좌 비밀번호가 필수입니다.
계좌 비밀번호가 설정되지 않았거나 잘못된 경우 `-301` 에러가 발생합니다.

### 에러 코드 설명
- **-301**: 계좌 비밀번호 오류
- 모의투자와 실계좌 모두 계좌 비밀번호 필요
- 로그인 비밀번호와는 다른 별도의 4자리 숫자 비밀번호

## 해결 방법

### 방법 1: .env 파일에 비밀번호 설정 (권장)

가장 빠르고 확실한 해결 방법입니다.

#### 단계 1: 키움 HTS에서 계좌 비밀번호 설정

**모의투자 계좌 비밀번호 설정:**

1. 키움 영웅문 HTS 실행
2. 로그인
3. 상단 메뉴: **[모의투자]** 클릭
4. **[계좌관리]** → **[계좌 비밀번호 등록/변경]** 선택
5. **4자리 숫자 비밀번호** 입력 (예: 0000, 1234)
   - 간단한 숫자 사용 가능 (모의투자는 보안 위험 낮음)
6. 저장 및 확인

**실계좌 비밀번호:**
- HTS에서 주문할 때 입력하는 4자리 비밀번호
- 이미 설정되어 있음 (계좌 개설 시 설정)

#### 단계 2: .env 파일 생성 또는 수정

**Windows PowerShell:**
```powershell
cd D:\cleonAI\auto_trading

# .env 파일이 없으면 생성
if (!(Test-Path .env)) {
    New-Item -ItemType File -Path .env
}

# 메모장으로 열기
notepad .env
```

**또는 파일 탐색기:**
1. `D:\cleonAI\auto_trading` 폴더 열기
2. `.env` 파일 찾기 (없으면 새로 만들기)
   - 파일 탐색기 상단: **보기** → **숨김 항목** 체크
3. 메모장으로 열기

#### 단계 3: .env 파일에 다음 내용 추가/수정

```env
# 키움증권 계좌 정보
KIWOOM_ACCOUNT_NUMBER=8113110311          # 본인의 계좌번호
KIWOOM_ACCOUNT_PASSWORD=0000               # 설정한 4자리 비밀번호

# 거래 모드
USE_SIMULATION=True                        # 모의투자: True

# 관심 종목
WATCH_LIST=005930,000660,035720            # 원하는 종목 코드
```

**중요 사항:**
- `KIWOOM_ACCOUNT_PASSWORD`에 HTS에서 설정한 4자리 비밀번호 입력
- 모의투자 예시: 0000, 1234, 1111 등
- 실계좌: 실제 계좌 비밀번호 (절대 노출 금지!)

#### 단계 4: 프로그램 재시작

```powershell
# 현재 실행 중인 프로그램 종료 (Ctrl+C)

# 재시작
.\start.bat
```

#### 단계 5: 확인

프로그램 시작 로그에서 다음 메시지 확인:
```
계좌 비밀번호: 설정됨 (****)
```

매수 시그널 발생 시:
```
✅ 매수 주문 전송 성공: [종목코드] [수량]주 @ [가격]원
```

---

### 방법 2: 키움 API 자체 비밀번호 저장 기능 사용

코드에 비밀번호를 저장하지 않고 키움 API의 자체 저장 기능을 활용합니다.

#### 단계 1: .env 파일에서 비밀번호 제거 또는 비워두기

```env
KIWOOM_ACCOUNT_PASSWORD=
```

또는 라인 자체를 삭제합니다.

#### 단계 2: 프로그램 실행

프로그램 시작 로그에 다음 경고가 표시됩니다:
```
⚠️ 계좌 비밀번호: 미설정 (키움 API 저장 비밀번호 사용 시도)
```

#### 단계 3: 팝업에서 비밀번호 입력

매수 시그널 발생 시 팝업이 나타나면:

1. 모의투자 계좌 비밀번호 입력 (4자리)
2. **"계좌 비밀번호 저장" 또는 "등록" 체크박스 반드시 체크** ✅
3. 확인 클릭

#### 단계 4: 이후 실행

키움 API가 비밀번호를 레지스트리에 암호화하여 저장합니다.
다음 실행부터는 팝업 없이 자동으로 주문이 진행됩니다.

**장점:**
- 코드에 비밀번호 노출 없음
- 보안 우수

**단점:**
- 최초 1회 수동 작업 필요
- PC 변경 시 다시 설정 필요

---

## 비밀번호 관련 주의사항

### 보안 수칙

1. **.env 파일을 Git에 절대 커밋하지 마세요**
   - `.gitignore`에 이미 포함되어 있음
   - 실수로 커밋 방지

2. **모의투자와 실계좌 비밀번호 구분**
   - 모의투자: 간단한 비밀번호 가능 (0000, 1234 등)
   - 실계좌: 복잡하고 안전한 비밀번호 사용 필수

3. **실계좌 사용 시 추가 주의**
   - .env 파일 권한 설정
   - 정기적인 비밀번호 변경
   - PC 보안 강화

### 비밀번호 구분

| 구분 | 용도 | 자릿수 | 설정 위치 |
|------|------|--------|-----------|
| 로그인 비밀번호 | HTS 로그인 | 제한 없음 | 키움증권 홈페이지 |
| 공동인증서 비밀번호 | 인증서 | 제한 없음 | 인증서 발급 시 |
| 계좌 비밀번호 | 주문 실행 | 4자리 | HTS 계좌관리 |

**이 가이드에서 다루는 비밀번호**: 계좌 비밀번호 (4자리)

---

## 문제 해결 FAQ

### Q1. 비밀번호를 입력했는데도 -301 에러가 발생합니다

**A**: 다음을 확인하세요:

1. **비밀번호가 정확한지 확인**
   - HTS에서 직접 주문하여 비밀번호 테스트
   - 잘못된 비밀번호인 경우 HTS에서도 주문 실패

2. **.env 파일 형식 확인**
   ```env
   # 올바른 형식
   KIWOOM_ACCOUNT_PASSWORD=0000
   
   # 잘못된 형식 (공백, 따옴표 없이!)
   KIWOOM_ACCOUNT_PASSWORD = "0000"  # ❌
   KIWOOM_ACCOUNT_PASSWORD= 0000     # ❌
   ```

3. **프로그램 재시작**
   - .env 파일 수정 후 반드시 프로그램 재시작

### Q2. 모의투자 계좌 비밀번호를 모릅니다

**A**: 키움 HTS에서 새로 설정하세요:

1. 키움 영웅문 HTS 로그인
2. [모의투자] → [계좌관리] → [계좌 비밀번호 등록]
3. 원하는 4자리 숫자 입력 (예: 0000)
4. 저장

모의투자는 간단한 비밀번호 사용 가능합니다.

### Q3. 실계좌로 전환하려는데 비밀번호 관리가 걱정됩니다

**A**: 다음 방법을 권장합니다:

**방법 1: 환경 변수 사용 (고급)**
```powershell
# Windows 환경 변수로 설정
[Environment]::SetEnvironmentVariable("KIWOOM_ACCOUNT_PASSWORD", "실제비밀번호", "User")

# .env 파일에서는 제거
```

**방법 2: KOA Studio 저장 기능 활용**
- .env 파일에 비밀번호 미설정
- 키움 API 자체 저장 기능 사용
- 가장 안전

**방법 3: 별도 암호화 저장소 사용**
- Windows 자격 증명 관리자
- 암호화된 파일

### Q4. 로그에 "계좌 비밀번호: 설정됨 (****)"이 표시되는데도 -301 에러가 발생합니다

**A**: 비밀번호는 설정되었지만 잘못된 경우입니다:

1. **HTS에서 비밀번호 확인**
   - 직접 주문하여 비밀번호 테스트
   
2. **비밀번호 초기화 후 재설정**
   ```powershell
   # .env 파일 수정
   KIWOOM_ACCOUNT_PASSWORD=
   ```
   
3. **프로그램 실행하여 팝업으로 입력**
   - 팝업에서 정확한 비밀번호 입력
   - "저장" 체크

### Q5. 계좌 비밀번호를 변경했습니다

**A**: .env 파일도 업데이트하세요:

```env
KIWOOM_ACCOUNT_PASSWORD=새로운비밀번호
```

또는 키움 API 저장 비밀번호를 사용 중이라면:
1. 프로그램 실행
2. 팝업에서 새 비밀번호 입력
3. "저장" 체크

---

## 테스트 방법

비밀번호 설정 후 올바르게 작동하는지 확인:

### 1. 로그 확인

```
계좌 비밀번호: 설정됨 (****)
```

### 2. 매수 시그널 대기

프로그램이 매수 조건을 감지할 때까지 대기

### 3. 매수 주문 성공 확인

```
✅ 매수 주문 전송 성공: 005930 10주 @ 75,000원
```

### 4. 에러 없음 확인

error_2025-xx-xx.log 파일에 -301 에러가 없어야 합니다.

---

## 참고 자료

- [GETTING_STARTED.md](../installation/GETTING_STARTED.md) - 전체 설정 가이드
- [KIWOOM_API_SETUP.md](../installation/KIWOOM_API_SETUP.md) - 키움 API 설정
- [TROUBLESHOOTING.md](TROUBLESHOOTING.md) - 기타 문제 해결

---

## 도움이 필요하신가요?

여전히 문제가 해결되지 않으면:

1. **로그 파일 확인**
   - `logs/error_2025-xx-xx.log`
   - `logs/trading_2025-xx-xx.log`

2. **키움증권 고객센터**
   - 전화: 1544-9000
   - 계좌 비밀번호 관련 문의

3. **프로젝트 이슈**
   - GitHub Issues에 로그와 함께 질문

