# 키움 Open API 호출 제한 완화 및 최적화 방안

**작성일**: 2025년 11월 2일  
**검토 대상**: 키움 Open API 호출 제한 (초당 5건, 일일 1,000건)  
**목적**: 더 많은 데이터를 효율적으로 수집하는 방법 조사

---

## 📋 조사 배경

### 현재 상황
- **API 호출 제한**: 초당 5건, 일일 1,000건
- **프로젝트 구현**: 초당 2건 (안전 마진)
- **문제점**: 급등주 다수 모니터링 시 제한 부족

### 조사 목적
API 호출 제한을 완화하거나 우회하여 더 많은 데이터를 효율적으로 가져오는 방법 찾기

---

## 🔍 조사 결과

### 1. 키움 공식 문서 조사 (koa_devguide.xml)

#### ✅ 발견: 연속조회(Prev_Next) 기능

**문서 내용** (라인 400-417):
```
[연속조회]
TR에는 한번에 조회할 수 있는 데이터 건수가 제한되어 있습니다.
이 제한보다 조회할 데이터가 많다면 연속조회로 모든 데이터를 조회할 수 있습니다.
연속조회는 CommRqData()에서 인자값을 바꿔서 다시 요청합니다.

CommRqData("일별주가조회", "OPT10086", 0, "0001");      
처음 요청한 데이터가 한번에 받을 데이터보다 더 많이 있다면
OnReceiveTRData()이벤트에서 5번째 인자값(sPrevNext)이 "2"로 수신됩니다.
이때 더 많은 데이터를 요청하고자 할때는
CommRqData("일별주가조회", "OPT10086", 2, "0001"); 
처럼 3번째 인자값을 2로 입력해서 조회하시면 됩니다.

반복하면 다음과 같습니다.
OpenAPI.CommRqData("일별주가조회", "OPT10086", 0, "0001"); // 처음조회 혹은 연속데이터가 없을때
OpenAPI.CommRqData("일별주가조회", "OPT10086", 2, "0001"); // 연속조회시 (필요시만 요청)

주의사항:
추가로 다른 TR 요청이 있는 경우 연속조회가 동작 안함.
```

**핵심 포인트**:
1. **한 번의 TR 조회 = 여러 건의 데이터** 수신 가능
2. `nPrevNext` 파라미터로 연속 데이터 요청
3. 한 번의 API 호출로 최대 데이터 획득 가능

#### ❌ 미발견: API 제한 완화 방법

키움 공식 문서에는 다음 내용이 **없음**:
- 일일 1,000건 한도 증가 방법
- 초당 5건 제한 완화 방법
- 프리미엄 서비스 관련 내용
- 기관 계좌 혜택 관련 내용

---

### 2. 현재 프로젝트 API 사용 분석

#### 현재 사용 중인 TR 코드 및 호출 빈도

| TR 코드 | 용도 | 호출 빈도 | 연속조회 사용 |
|---------|------|----------|--------------|
| **OPW00001** | 예수금 조회 | 초기화 시 1회 | ❌ 미사용 |
| **OPW00018** | 보유 종목 조회 | 초기화 시 1회 | ❌ 미사용 |
| **OPT10001** | 현재가 조회 | 거의 사용 안 함 | ❌ 미사용 |
| **OPT10023** | 거래대금 상위 종목 | 급등주 초기화 시 1회 | ❌ 미사용 |

#### 실시간 데이터 활용 현황

✅ **이미 최적화되어 있음**:
- `SetRealReg()` 로 실시간 시세 등록 (관심 종목 + 급등주 후보군)
- 실시간 데이터로 매매 신호 생성
- TR 조회 대신 실시간 데이터 활용

#### API 호출 통계 (추정)

**프로그램 시작 시**:
1. 잔고 조회 (OPW00001): 1건
2. 보유 종목 조회 (OPW00018): 1건
3. 거래대금 상위 종목 조회 (OPT10023): 1건
4. 실시간 시세 등록 (SetRealReg): 1-2건 (배치 처리)

**총 초기 호출**: 약 4-5건 (1초 이내 완료)

**운영 중**:
- 실시간 데이터만 수신 (추가 TR 조회 없음)
- 매매 주문 발생 시 SendOrder 호출 (조회 한도 X)

**결론**: **현재 프로젝트는 이미 API 호출을 최소화하고 있음** ✅

---

### 3. 연속조회(Prev_Next) 활용 방안

#### 적용 가능한 TR 코드

##### ✅ OPT10023 (거래대금 상위 종목)

**현재 구현** (`kiwoom_api.py` 라인 601-701):
```python
def get_top_traded_stocks(self, count: int = 100):
    # ...
    ret = self.ocx.dynamicCall("CommRqData(...)", 
        "거래대금상위요청", "OPT10023", 0, "2003")  # nPrevNext = 0
```

**문제점**:
- 한 번에 최대 100개 종목만 조회 가능 (TR 제한)
- 200개 이상 필요 시 여러 번 호출 필요

**개선 방안**:
```python
def get_top_traded_stocks(self, count: int = 100, max_count: int = 200):
    """
    거래대금 상위 종목 조회 (연속조회 지원)
    
    Args:
        count: 기본 조회 수
        max_count: 최대 조회 수 (연속조회로 확장)
    """
    all_stocks = []
    prev_next = 0  # 처음 조회
    
    while len(all_stocks) < max_count:
        ret = self.ocx.dynamicCall("CommRqData(...)", 
            "거래대금상위요청", "OPT10023", prev_next, "2003")
        
        if ret == 0:
            self.request_event_loop.exec_()
            stocks = self.data_cache.get('top_traded_stocks', [])
            all_stocks.extend(stocks)
            
            # 연속 데이터 확인
            if self.has_more_data:  # OnReceiveTrData에서 sPrevNext 체크
                prev_next = 2  # 연속조회
            else:
                break  # 더 이상 데이터 없음
    
    return all_stocks[:max_count]
```

**효과**:
- **API 호출 수 동일** (연속조회도 1건으로 카운트)
- **한 번의 호출로 여러 배치 데이터 수신**
- 200-300개 종목 조회 가능 (TR 제한에 따라 다름)

##### ⚠️ OPW00018 (보유 종목 조회)

**현재**: 보유 종목이 많지 않아 연속조회 불필요
**적용 시기**: 보유 종목이 20개 이상일 때 고려

---

### 4. 프리미엄 서비스 / 기관 계좌 조사

#### 웹 검색 결과

❌ **공식적인 제한 완화 방법 없음**:
- 키움증권 홈페이지, 고객센터 FAQ 확인 결과
- 일반 개인 계좌 = 프리미엄 계좌 = 기관 계좌 **모두 동일한 제한**
- 초당 5건, 일일 1,000건은 **시스템 안정성을 위한 고정 제한**

#### 고객센터 문의 권장 사항

다음 내용을 키움 고객센터(1544-9000)에 문의 가능:
1. API 조회 한도 증가 신청 가능 여부
2. 기관 투자자 계정의 혜택
3. 특정 TR의 연속조회 최대 건수

---

### 5. 합법적 최적화 방법

#### ✅ 즉시 적용 가능

##### 1. 연속조회 기능 구현

**효과**:
- 한 번의 API 호출로 더 많은 데이터 수신
- 특히 OPT10023(거래대금 상위) 200-300개 조회 가능

**구현 난이도**: ⭐⭐ (중)

##### 2. 실시간 데이터 활용 극대화 (✅ 이미 구현됨)

**현재 상태**:
- 관심 종목 + 급등주 후보군 실시간 등록
- TR 조회 대신 실시간 데이터로 매매 신호 생성

**효과**: API 조회 호출 최소화

##### 3. 캐싱 전략 강화

**현재**: 데이터베이스 저장 기능 있음 (선택적)

**개선 방안**:
```python
# 일봉/주봉 데이터는 한 번 조회 후 캐시
# 당일 이미 조회한 데이터 재사용
# 일일 한도 절약
```

##### 4. 조회 스케줄링

**방법**:
- 급등주 후보군 갱신: 1시간마다 (하루 6회)
- 계좌 정보 조회: 필요 시에만 (매매 전후)
- 비장중 시간에 과거 데이터 조회

**효과**: 일일 1,000건 한도 내에서 효율적 운영

##### 5. 배치 처리 최적화 (✅ 이미 구현됨)

**현재 구현**:
- 실시간 등록 50개씩 배치 처리
- API 과부하 방지

---

## 🚫 금지된 방법

### ❌ 절대 시도하면 안 되는 것들

1. **여러 계좌로 제한 우회**
   - 키움 정책: 1인 1계정 원칙
   - 이용약관 위반

2. **API 제한 강제 우회**
   - 기술적 우회 시도 (다중 연결 등)
   - 시스템 안정성 해침
   - 계정 정지 위험

3. **웹 스크래핑**
   - 키움 웹사이트 크롤링
   - 저작권 침해
   - 불안정한 데이터

---

## 📊 최종 권장 사항

### 🎯 즉시 적용 (우선순위 높음)

#### 1. 연속조회 기능 구현 ⭐⭐⭐

**구현 위치**: `kiwoom_api.py` - `get_top_traded_stocks()`

**구현 내용**:
```python
def get_top_traded_stocks(self, count: int = 100, max_iterations: int = 3):
    """
    거래대금 상위 종목 조회 (연속조회 지원)
    
    Args:
        count: 1회 조회 수
        max_iterations: 최대 연속조회 횟수 (API 제한 고려)
    
    Returns:
        최대 count * max_iterations 개 종목
    """
    all_stocks = []
    prev_next = 0
    
    for iteration in range(max_iterations):
        # API 제한 준수
        self._wait_for_request()
        
        # TR 요청 (nPrevNext 파라미터 전달)
        ret = self.ocx.dynamicCall("CommRqData(...)", 
            "거래대금상위요청", "OPT10023", prev_next, "2003")
        
        if ret == 0:
            self.request_event_loop.exec_()
            stocks = self.data_cache.get('top_traded_stocks', [])
            all_stocks.extend(stocks)
            
            # 연속 데이터 여부 확인
            if self.last_prev_next == "2":
                prev_next = 2  # 다음 조회는 연속조회
                log.info(f"연속조회 {iteration + 1}/{max_iterations}: {len(stocks)}개 추가")
            else:
                log.info("연속 데이터 없음 - 조회 종료")
                break
        else:
            log.error(f"TR 요청 실패: {ret}")
            break
    
    log.success(f"총 {len(all_stocks)}개 종목 조회 완료")
    return all_stocks
```

**OnReceiveTrData 수정**:
```python
def _on_receive_tr_data(self, ..., prev_next, ...):
    # prev_next 값 저장
    self.last_prev_next = prev_next
    
    # 기존 로직...
```

**효과**:
- **API 호출 수 증가**: 1회 → 3회 (max_iterations=3)
- **데이터 양 증가**: 100개 → 300개
- **일일 한도**: 3건 사용 (충분히 여유 있음)

#### 2. 조회 스케줄 최적화 ⭐⭐

**현재 문제점**:
- 프로그램 시작 시 한 번만 조회
- 장중 변동 사항 반영 안 됨

**개선 방안**:
```python
# trading_engine.py
class TradingEngine:
    def __init__(self):
        # ...
        self.last_refresh_time = None
        self.refresh_interval = 3600  # 1시간 (초 단위)
    
    def _periodic_check(self):
        # 기존 로직...
        
        # 급등주 후보군 갱신 (1시간마다)
        current_time = time.time()
        if self.last_refresh_time is None or \
           (current_time - self.last_refresh_time) > self.refresh_interval:
            self.refresh_surge_candidates()
            self.last_refresh_time = current_time
    
    def refresh_surge_candidates(self):
        """급등주 후보군 갱신"""
        if self.surge_detector:
            log.info("급등주 후보군 갱신 중...")
            self.surge_detector.initialize()  # 재초기화
```

**효과**:
- 하루 6-7회 갱신 (장중 6시간)
- 변동된 거래대금 상위 종목 반영
- 일일 한도: 약 18-21건 (연속조회 포함)

### ⏰ 중장기 검토

#### 3. 데이터베이스 활용 강화 ⭐

**현재**: 선택적 기능 (`DB_ENABLED=False`)

**개선 방안**:
```python
# config.py
DB_ENABLED = True  # 기본 활성화

# 과거 데이터 캐싱
# - 일봉: 한 번 조회 후 재사용
# - 당일 조회한 종목: 재조회 방지
```

#### 4. 고객센터 문의

**문의 내용**:
1. "API 조회 한도 1,000건을 증가할 수 있는 방법이 있나요?"
2. "연속조회 시 최대 몇 회까지 가능한가요?"
3. "기관 투자자 계정은 한도가 다른가요?"

**연락처**: 1544-9000 (내선 2번 → 1번, Open API 문의)

---

## 📈 예상 효과

### 연속조회 구현 후

**Before (현재)**:
- 급등주 후보군: 100개 (1회 조회)
- API 사용: 4-5건/일
- 일일 한도 사용률: 0.5%

**After (연속조회 적용)**:
- 급등주 후보군: 300개 (3회 연속조회)
- 1시간마다 갱신 (하루 6회)
- API 사용: 약 20-25건/일
- 일일 한도 사용률: 2-2.5%
- **여전히 975건 남음** (충분)

### 기대 효과

1. **급등주 감지 정확도 향상**
   - 100개 → 300개 모니터링
   - 놓치는 종목 감소

2. **변동 사항 실시간 반영**
   - 1시간마다 후보군 갱신
   - 장중 거래대금 변화 반영

3. **API 한도 여유**
   - 2.5% 사용 (97.5% 남음)
   - 추가 기능 개발 여지

---

## ✅ 결론

### 핵심 발견

1. **API 제한 완화 방법 없음**
   - 프리미엄 서비스, 기관 계좌 모두 동일한 제한
   - 초당 5건, 일일 1,000건은 **고정**

2. **현재 프로젝트는 이미 최적화됨**
   - 실시간 데이터 적극 활용
   - TR 조회 최소화
   - 배치 처리 구현

3. **연속조회 = 핵심 개선 포인트**
   - 한 번의 호출로 더 많은 데이터
   - API 한도 여유 충분
   - 즉시 적용 가능

### 최종 권장 사항

✅ **즉시 적용**: 연속조회 기능 구현  
✅ **중기 검토**: 1시간마다 후보군 갱신  
✅ **장기 검토**: 데이터베이스 캐싱 강화

❌ **금지**: API 제한 강제 우회, 여러 계좌 사용, 웹 스크래핑

---

**작성 완료일**: 2025년 11월 2일  
**다음 단계**: 연속조회 기능 구현 (`kiwoom_api.py` 수정)

