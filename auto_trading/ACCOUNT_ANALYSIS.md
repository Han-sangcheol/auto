# 계좌번호 및 비밀번호 사용 분석 (최종 확정)

## 📚 키움 Open API 공식 문서 (koa_devguide.xml)

### SendOrder 함수 정의
```
SendOrder(
    BSTR sRQName,     // 사용자 구분명
    BSTR sScreenNo,   // 화면번호
    BSTR sAccNo,      // 계좌번호 10자리 ← 계좌번호만!
    LONG nOrderType,  // 주문유형 (1:신규매수, 2:신규매도)
    BSTR sCode,       // 종목코드 (6자리)
    LONG nQty,        // 주문수량
    LONG nPrice,      // 주문가격
    BSTR sHogaGb,     // 거래구분 (00:지정가, 03:시장가)
    BSTR sOrgOrderNo  // 원주문번호 ← 신규주문은 빈 문자열("")
)
```

## ✅ 정확한 구현 방법

### 1. 계좌번호
- **10자리 계좌번호만 전달**
- 예: `"8113110311"`
- ❌ 비밀번호 결합 불필요: `"8113110311;0000;00"` (잘못된 방식)

### 2. 계좌 비밀번호
- **SendOrder 함수에서 전달하지 않음**
- **로그인 후 "계좌 비밀번호 등록"에서 한 번만 입력**
- 방법 1: 메뉴 이용 - 트레이 아이콘 우클릭 → "계좌비밀번호 등록"
- 방법 2: 함수 이용 - `KOA_Functions("ShowAccountWindow", "")`

### 3. 원주문번호
- **신규 주문**: 빈 문자열 `""`
- **정정/취소**: 원래 주문번호

## 🔍 올바른 코드

### buy_order() 예시
```python
ret = self.ocx.dynamicCall(
    "SendOrder(QString, QString, QString, int, QString, int, int, QString, QString)",
    [
        "매수",                    # 사용자 구분명
        "0101",                    # 화면번호
        self.account_number,       # 계좌번호 10자리 (예: "8113110311")
        1,                         # 주문유형 (1:신규매수)
        stock_code,                # 종목코드
        quantity,                  # 주문수량
        price,                     # 주문가격
        order_type,                # 거래구분 (00:지정가, 03:시장가)
        ""                         # 원주문번호 (신규주문은 빈 문자열)
    ]
)
```

## 🚫 잘못된 이전 구현

### 잘못된 방식 1: 계좌번호에 비밀번호 결합
```python
# ❌ 잘못됨
account_with_pw = f"{self.account_number};{self.account_password};00"
ret = self.ocx.dynamicCall("SendOrder(...)", [..., account_with_pw, ...])
```

### 잘못된 방식 2: 원주문번호 자리에 비밀번호 전달
```python
# ❌ 잘못됨
ret = self.ocx.dynamicCall("SendOrder(...)", [..., self.account_password])
```

## 📋 계좌 비밀번호 등록 방법

### 모의투자 계좌
1. 키움 OpenAPI 로그인 (모의투자 체크)
2. 로그인 성공 후 시스템 트레이 아이콘 확인
3. 트레이 아이콘 우클릭 → "계좌비밀번호 등록"
4. 계좌번호 선택: `81131103` 또는 `8113110311`
5. 비밀번호 입력: `0000` (또는 원하는 4자리)
6. 확인 클릭
7. **이후 모든 주문에서 자동으로 적용됨**

### 실계좌
- 실제 계좌 비밀번호 (4자리) 입력
- HTS에서 설정한 계좌 비밀번호와 동일

## 🎯 핵심 요약

| 항목 | 올바른 방식 | 잘못된 방식 |
|------|------------|------------|
| **계좌번호** | `"8113110311"` (10자리만) | `"8113110311;0000;00"` |
| **비밀번호 전달** | SendOrder에서 전달 안 함 | 마지막 파라미터에 전달 |
| **비밀번호 등록** | 로그인 후 한 번만 등록 | 매번 전달 시도 |
| **원주문번호** | 신규 주문은 `""` | 비밀번호를 넣음 |

## 🧪 테스트 방법

1. 코드 수정 완료 ✅
2. 프로그램 재시작
3. 로그인 후 계좌 비밀번호 등록 (최초 1회)
4. 급등주 감지 대기
5. 주문 성공 확인:
   ```
   ✅ 매수 주문 전송 성공: [종목코드] [수량]주 @ [가격]원
   ```

## 🔧 수정 내역

### 2025-10-31 최종 수정
- ✅ SendOrder 함수 파라미터를 공식 문서에 맞게 수정
- ✅ 계좌번호에 비밀번호 결합 제거
- ✅ 원주문번호 자리에 빈 문자열 전달
- ✅ buy_order() 및 sell_order() 모두 수정 완료

## 📖 참고 문서

- 키움 Open API 공식 가이드: `C:\OpenAPI\koa_devguide.xml`
- SendOrder 함수 정의: 라인 918-993
- 계좌 비밀번호 등록: 라인 803-812
