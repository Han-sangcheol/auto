# Ctrl+C 종료 문제 해결

**날짜**: 2025-10-27  
**목적**: Ctrl+C로 프로그램 종료가 안 되는 문제 해결  
**상태**: ✅ 완료

---

## 📋 문제 상황

> "컨트롤 c 로 종료가 안됩니다."

**문제**:
- 프로그램 실행 중 Ctrl+C를 눌러도 종료되지 않음
- PyQt 이벤트 루프가 블로킹되어 시그널 처리가 안 됨
- 강제 종료만 가능 (X 버튼 클릭, 작업 관리자)

---

## 🔍 원인 분석

### PyQt 이벤트 루프의 블로킹

**기존 코드**:
```python
# PyQt 이벤트 루프 실행
app.exec_()
```

**문제점**:
- `app.exec_()`는 블로킹 호출
- 이벤트 루프가 실행되는 동안 Python의 시그널 처리가 안 됨
- Ctrl+C (SIGINT)가 무시됨

**결과**:
- ❌ Ctrl+C로 종료 불가
- ❌ KeyboardInterrupt 예외 발생 안 됨
- ❌ 안전한 종료 불가

---

## 🔧 해결 방법

### 1. signal 모듈 추가

**파일**: `auto_trading/main.py` (20-26번 라인)

```python
import sys
import os
import signal           # 🆕 추가
import threading
from datetime import datetime
from PyQt5.QtWidgets import QApplication
from PyQt5.QtCore import QTimer  # 🆕 추가
from kiwoom_api import KiwoomAPI
from trading_engine import TradingEngine
from logger import log
from config import Config
```

---

### 2. Signal 핸들러 설정

**파일**: `auto_trading/main.py` (245-255번 라인)

```python
# Ctrl+C (SIGINT) 처리를 위한 signal 핸들러 설정
def signal_handler(signum, frame):
    log.warning("\n🛑 Ctrl+C 감지 - 프로그램을 안전하게 종료합니다...")
    app.quit()

signal.signal(signal.SIGINT, signal_handler)

# Python의 시그널 처리를 허용하기 위한 타이머 (500ms마다 Python 코드 실행)
timer = QTimer()
timer.start(500)
timer.timeout.connect(lambda: None)  # 빈 함수 실행으로 Python 시그널 체크
```

**작동 원리**:
1. `signal.signal(signal.SIGINT, signal_handler)`: Ctrl+C 시그널 처리 함수 등록
2. `signal_handler`: Ctrl+C 감지 시 `app.quit()` 호출
3. `QTimer`: 500ms마다 Python 코드 실행 → 시그널 체크 기회 제공

---

### 3. 안전한 종료 처리

**파일**: `auto_trading/main.py` (260-268번 라인)

```python
# 이벤트 루프 실행
exit_code = app.exec_()

# 종료 처리
log.info("자동매매를 종료합니다...")
engine.stop_trading()
kiwoom.disconnect()

# 최종 통계
log.success("✅ 프로그램을 정상 종료했습니다.")

return exit_code
```

**효과**:
- ✅ 자동매매 엔진 정상 종료
- ✅ 키움 API 연결 해제
- ✅ 리소스 정리

---

## 📊 실행 예시

### Ctrl+C 종료

```
2025-10-27 12:02:36 | INFO  | 📡 PyQt 이벤트 루프 실행 중... (GUI 응답 유지)
2025-10-27 12:02:36 | INFO  |    종료하려면 Ctrl+C를 누르세요.

(사용자가 Ctrl+C 입력)

2025-10-27 12:05:42 | WARNING | 
🛑 Ctrl+C 감지 - 프로그램을 안전하게 종료합니다...

2025-10-27 12:05:42 | INFO  | 자동매매를 종료합니다...
2025-10-27 12:05:42 | INFO  | 🛑 자동매매 중지
2025-10-27 12:05:42 | INFO  | 급등주 모니터링 중지
2025-10-27 12:05:43 | SUCCESS | ✅ 프로그램을 정상 종료했습니다.
```

---

## ✅ 개선 사항

### 변경 전

| 동작 | 결과 |
|------|------|
| Ctrl+C 입력 | ❌ 무시됨 |
| 종료 방법 | 강제 종료만 가능 |
| 안전한 종료 | ❌ 불가 |
| 리소스 정리 | ❌ 안 됨 |

### 변경 후

| 동작 | 결과 |
|------|------|
| Ctrl+C 입력 | ✅ 즉시 감지 |
| 종료 방법 | ✅ 정상 종료 |
| 안전한 종료 | ✅ 가능 |
| 리소스 정리 | ✅ 자동 |

---

## 🚀 즉시 적용

프로그램을 재시작하면 바로 적용됩니다:

```cmd
cd auto_trading
python main.py
```

**실행 후**:
- Ctrl+C 입력 → 즉시 종료됨 ✅
- 안전한 리소스 정리 ✅
- 로그에 종료 메시지 출력 ✅

---

## 🔍 동작 확인

### 1. 프로그램 시작

```
📡 PyQt 이벤트 루프 실행 중... (GUI 응답 유지)
   종료하려면 Ctrl+C를 누르세요.
```

### 2. Ctrl+C 입력

```
(키보드에서 Ctrl+C 입력)

🛑 Ctrl+C 감지 - 프로그램을 안전하게 종료합니다...
```

### 3. 정상 종료 확인

```
자동매매를 종료합니다...
🛑 자동매매 중지
✅ 프로그램을 정상 종료했습니다.
```

---

## 🐛 트러블슈팅

### 여전히 Ctrl+C가 안 먹힘

**확인 사항**:

1. **Python 버전 확인**
   - Python 3.7 이상 필요
   - 현재: Python 3.11.9 (정상)

2. **터미널 확인**
   - PowerShell: Ctrl+C 정상 작동
   - CMD: Ctrl+C 정상 작동
   - Git Bash: Ctrl+C 또는 Ctrl+D

3. **프로그램 재시작**
   - 이전 버전이 실행 중일 수 있음
   - 프로그램 종료 후 재시작

---

### 프로그램이 즉시 종료되지 않음

**원인**:
- 진행 중인 작업이 있을 수 있음 (매수/매도 주문 등)

**해결**:
- 잠시 기다리면 자동으로 종료됨 (최대 1-2초)
- 로그에서 종료 진행 상황 확인

---

## 💡 추가 기능

### 다른 종료 방법

1. **X 버튼 클릭**
   - GUI 창의 X 버튼
   - 정상 종료 처리됨

2. **작업 관리자**
   - 최후의 수단
   - 비정상 종료 (권장하지 않음)

---

## 🎯 기술 세부사항

### Signal 처리 메커니즘

```python
# 1. Signal 핸들러 등록
signal.signal(signal.SIGINT, signal_handler)

# 2. QTimer로 Python 시그널 체크 기회 제공
timer = QTimer()
timer.start(500)  # 500ms마다
timer.timeout.connect(lambda: None)  # Python 코드 실행

# 3. Ctrl+C 입력 시
# → SIGINT 발생
# → signal_handler 호출
# → app.quit() 실행
# → PyQt 이벤트 루프 종료
```

---

### QTimer의 역할

**문제**:
- PyQt 이벤트 루프가 순수 C++ 코드로 실행됨
- Python 시그널 핸들러가 실행될 기회가 없음

**해결**:
- QTimer로 500ms마다 Python 코드 실행
- Python 인터프리터가 시그널을 체크할 기회 제공
- 시그널 핸들러가 정상 실행됨

---

## 🎉 결과

### 해결된 문제

1. ✅ **Ctrl+C 정상 작동** - 즉시 종료
2. ✅ **안전한 종료** - 리소스 정리
3. ✅ **로그 출력** - 종료 메시지 명확
4. ✅ **사용자 경험** - 직관적인 종료

---

## 📝 관련 코드

**파일**: `auto_trading/main.py`

**수정된 부분**:
1. import 추가 (20-26번 라인)
2. signal 핸들러 설정 (245-255번 라인)
3. 안전한 종료 처리 (260-268번 라인)

---

**작성**: CleonAI 개발팀  
**날짜**: 2025-10-27  
**버전**: v1.3  
**상태**: ✅ 완료

**이제 Ctrl+C로 언제든지 안전하게 프로그램을 종료할 수 있습니다!**

---


