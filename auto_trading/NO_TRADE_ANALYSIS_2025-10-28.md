# 매수/매도 미실행 원인 분석 (2025-10-28)

## 문제 상황

**증상**: 하루 종일 프로그램 실행했으나 단 한 건의 매수/매도도 이루어지지 않음

## 로그 분석 결과

### 1. 급등주 감지 현황

**총 17건의 급등 감지 발생**

| 시간 | 감지 건수 | 종목 예시 | 결과 |
|------|----------|----------|------|
| 11:09 | 5건 | 아이씨티케이(+12.48%), 메타랩스(+22.20%) 등 | ❌ 매수 실패 (블로킹) |
| 14:22 | 3건 | 예선테크(+2%), 엠오티(+13%) 등 | ❌ 매수 실패 (파라미터 오류) |
| 14:27 | 4건 | 범한퓨얼셀, 텔콘RF제약 등 | ❌ 매수 실패 (블로킹) |
| 14:35 | 4건 | 닷밀(+22%), 두산퓨얼셀 등 | ❌ 매수 실패 (블로킹) |
| 15:30 | 1건 | 아이씨티케이(+10.03%) | ❌ 매수 불가 (장 마감) |

### 2. 실패 원인 분석

#### A. 11:09 - 실시간 시세 등록 블로킹

**로그:**
```
11:09:55 | ✅ 급등주 추가: 아이씨티케이 (456010)
11:09:55 | 🔍 실시간 시세 등록 시도: 456010
(이후 로그 없음 - 블로킹)
```

**원인:**
- `trading_engine.py`의 `add_surge_stock()` 함수에서
- `self.kiwoom.register_real_data([stock_code])` 호출
- PyQt COM 객체 메서드를 메인 스레드가 아닌 곳에서 호출하여 블로킹 발생
- 이후 매수 로직(`execute_buy`) 실행 안 됨

**영향:**
- 첫 번째 급등주(아이씨티케이) 처리가 블로킹됨
- `surge_processing` 플래그가 해제되지 않음
- 이후 감지된 모든 급등주가 대기 상태로 진입
- "⏳ 다른 급등주 처리 중 - 대기" 메시지 반복

**해결 방법:**
- `BLOCKING_FIX_2025-10-28.md`에서 수정 완료
- `register_real_data()` 호출 제거 (surge_detector가 이미 등록함)
- **프로그램 재시작 필요**

#### B. 14:22 - 콜백 파라미터 오류

**로그:**
```
error_2025-10-28.log:57:
14:22:04 | ERROR | 급등주 승인 처리 중 오류: 
create_surge_approval_callback.<locals>.surge_approval_callback() 
takes 2 positional arguments but 3 were given
```

**원인:**
- `trading_engine.py`에서 콜백 호출 시 3개 인자 전달:
  ```python
  surge_approval_callback(stock_code, candidate.name, surge_info)
  ```
- `main.py`의 콜백 함수는 2개 인자만 받음:
  ```python
  def surge_approval_callback(stock_code: str, candidate) -> bool:
  ```

**영향:**
- 콜백 함수 호출 실패
- 매수 프로세스가 시작되지 않음

**해결 방법:**
- `CALLBACK_PARAMETER_FIX_2025-10-28.md`에서 수정 완료
- `trading_engine.py` 수정: 2개 인자만 전달
- **프로그램 재시작 필요**

#### C. 14:27, 14:35 - 인덴트 및 블로킹 문제

**원인:**
- 인덴트 오류로 매수 로직이 실행되지 않음 (`INDENT_FIX`)
- `register_real_data()` 블로킹 (`BLOCKING_FIX`)

**해결 방법:**
- 모두 수정 완료
- **프로그램 재시작 필요**

#### D. 15:30 - 장 마감

**로그:**
```
15:30:02 | 🚀 급등 감지! 아이씨티케이 (456010)
15:30:02 | 🔍 [execute_buy] 키움 API buy_order 호출 중...
(이후 로그 없음)
```

**원인:**
- **한국 주식시장 마감 시간: 15:30**
- 15:30:02에 매수 시도했지만 이미 장이 마감됨
- 키움 API의 `SendOrder`가 실패했지만 에러 로그 없음

**영향:**
- 주문이 접수되지 않음
- 장 마감 후에는 주문 불가

### 3. 관심 종목 (WATCH_LIST) 매매 현황

**분석:**
```python
# config.py
WATCH_LIST = ['005930', '000660', '035720']  # 삼성전자, SK하이닉스, 카카오
```

**결과:**
- 로그에 관심 종목의 매수 신호 생성 기록 없음
- 이유:
  1. 급등주 감지 시스템만 작동 (관심 종목 전략은 미사용)
  2. 또는 관심 종목의 가격 변동이 매수 조건을 만족하지 못함

### 4. API 과부하 경고

**로그:**
```
error_2025-10-28.log:
07:19:13 | ERROR | ❌ 잔고 조회 실패: -202 (조회 과부하)
07:19:27 | ERROR | ❌ 보유종목 조회 실패: -202 (조회 과부하)
07:19:28 | ERROR | 거래대금 상위 종목 조회 실패
```

**원인:**
- 키움 API 조회 한도 초과 (에러 코드 -202)
- 프로그램 시작 시 초기화 과정에서 여러 번 재시도

**영향:**
- 급등주 후보군 조회 실패
- 프로그램 시작 지연

**해결 방법:**
- 이미 `OVERLOAD_FIX`에서 조회 간격 조정 완료
- 재시도 로직 포함
- 큰 문제는 아님

## 근본 원인

### ⚠️ **가장 중요한 원인**

**오늘 실행된 프로그램이 수정 전 버전입니다!**

- 오전 11시경 프로그램 시작
- 오후에 여러 버그 수정 (콜백 파라미터, 인덴트, 블로킹 등)
- **하지만 프로그램을 재시작하지 않음**
- 따라서 수정사항이 반영되지 않음

## 해결 방법

### 즉시 조치 사항

#### 1. 프로그램 재시작 (필수!)

```bash
# 현재 실행 중인 프로그램 종료
# GUI 창을 닫거나 Ctrl+C

# 프로그램 재시작
start.bat
```

#### 2. 최신 버전 확인

최근 수정사항:
- ✅ `CALLBACK_PARAMETER_FIX_2025-10-28.md` (콜백 파라미터 수정)
- ✅ `INDENT_FIX_2025-10-28.md` (인덴트 수정)
- ✅ `BLOCKING_FIX_2025-10-28.md` (블로킹 수정)
- ✅ `GUI_INTEGRATION_2025-10-28.md` (GUI 중심 재구성)

#### 3. 설정 최적화

**config.py 또는 .env 파일:**

```ini
# 급등주 감지 조건 (현재 설정 확인)
SURGE_MIN_CHANGE_RATE=5.0         # 최소 상승률 (%)
SURGE_MIN_VOLUME_RATIO=2.0        # 최소 거래량 비율
SURGE_MIN_BUYING_PRESSURE=0.0     # 매수세 조건 (현재 비활성화)
SURGE_CANDIDATE_COUNT=30          # 후보군 개수 (과부하 방지)

# 자동 승인
SURGE_AUTO_APPROVE=True           # 자동 승인 활성화

# 급등주 감지
ENABLE_SURGE_DETECTION=True       # 급등주 감지 활성화
```

### 추가 권장 사항

#### 1. 모의투자 모드 확인

```ini
# .env
USE_SIMULATION=True  # 모의투자로 테스트
```

#### 2. 장중에 실행

- **한국 주식시장 거래 시간: 09:00 ~ 15:30**
- 프로그램 시작 권장 시간: **09:00 ~ 14:00**
- 15:30 이후는 장 마감으로 거래 불가

#### 3. 로그 모니터링

```bash
# 실시간 로그 확인
Get-Content logs\trading_2025-10-28.log -Wait -Tail 30
```

**확인 사항:**
- "🚀 급등 감지!" 메시지
- "✅ 급등주 자동 승인" 메시지
- "📈 매수 시도" 메시지
- "✅ 매수 주문 전송 성공" 메시지

#### 4. GUI 모니터링

- GUI 창에서 "자동매매 시작" 버튼 클릭
- 실시간 로그 확인
- 급등주 현황 확인

## 예상 결과 (재시작 후)

### 정상 동작 시나리오

```
09:00 - 프로그램 시작
  ↓
09:05 - 급등주 모니터링 시작
  ↓
10:30 - 급등 감지! (예: 종목A +8%)
  ↓
10:30 - ✅ 자동 승인
  ↓
10:30 - 📈 매수 시도: 종목A 100주
  ↓
10:30 - ✅ 매수 주문 전송 성공
  ↓
10:30 - 🎯 매수 체결! (종목A 100주 @ 10,000원)
  ↓
14:00 - 목표가 도달 또는 손절 조건 만족
  ↓
14:00 - 📉 매도 시도: 종목A 100주
  ↓
14:00 - ✅ 매도 주문 전송 성공
  ↓
14:00 - 💰 매도 체결! 수익: +5%
```

## 체크리스트

재시작 전 확인:

- [ ] 최신 코드로 업데이트됨 (git pull 또는 파일 확인)
- [ ] .env 파일 설정 확인
- [ ] 모의투자 모드 설정 (`USE_SIMULATION=True`)
- [ ] 계좌 번호 및 비밀번호 확인
- [ ] 장 시작 시간 확인 (09:00 ~ 15:30)

재시작 후 확인:

- [ ] GUI 창 정상 표시
- [ ] 로그인 성공
- [ ] "자동매매 시작" 버튼 클릭
- [ ] 급등주 모니터링 시작 로그 확인
- [ ] 실시간 데이터 수신 확인
- [ ] GUI 로그 정상 출력

## 요약

### 오늘 매수/매도가 없었던 이유

1. ❌ **프로그램이 수정 전 버전** (블로킹, 파라미터 오류 포함)
2. ❌ **블로킹 문제로 첫 급등주 처리가 멈춤**
3. ❌ **이후 모든 급등주가 대기 상태**
4. ❌ **15:30 장 마감 후 시도는 불가**

### 해결 방법

✅ **프로그램을 재시작하면 정상 작동합니다!**

모든 버그가 수정되었으므로, 다음 장 시작 시간(내일 09:00)에 프로그램을 재시작하면:
- 급등주 자동 감지 ✓
- 자동 승인 ✓
- 즉시 매수 ✓
- 목표가/손절가 자동 매도 ✓

---

**작성 시간**: 2025-10-28
**상태**: ✅ 원인 분석 완료
**조치**: 🔄 프로그램 재시작 필요
**예상 결과**: 🎯 다음 장 시작 시 정상 작동

