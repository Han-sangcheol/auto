# CleonAI 자동매매 프로그램 개발 규칙

## 프로젝트 구조
- 작업 폴더: `auto_trading/`
- 가상환경: `.venv/` (프로젝트 루트)
- Python 버전: 3.13.8

## 가상환경 활성화
```powershell
# Windows PowerShell
.\.venv\Scripts\Activate.ps1

# Windows CMD
.venv\Scripts\activate.bat
```

## 코딩 규칙

### Python 스타일
- PEP 8 준수
- 타입 힌트 사용 권장
- Docstring은 Google 스타일
- 한글 주석 허용 (설명이 필요한 비즈니스 로직)

### 파일 구조
```
auto_trading/
├── main.py              # 메인 실행 파일
├── config.py            # 설정 관리
├── logger.py            # 로깅 시스템
├── kiwoom_api.py        # 키움 API 래퍼
├── indicators.py        # 기술적 지표
├── strategies.py        # 매매 전략
├── risk_manager.py      # 리스크 관리
├── trading_engine.py    # 자동매매 엔진
├── requirements.txt     # 패키지 의존성
├── .env                 # 환경 변수 (Git 제외)
└── logs/               # 로그 파일
```

### 환경 변수
- `.env` 파일 사용 (python-dotenv)
- 민감한 정보는 절대 코드에 하드코딩 금지
- `.env` 파일은 `.gitignore`에 포함

### 로깅
- `loguru` 라이브러리 사용
- 모든 중요 이벤트 로깅
- 에러는 `logs/error.log`에 별도 저장
- 일반 로그는 `logs/trading.log`에 저장

### 에러 처리
- try-except 블록으로 모든 외부 호출 감싸기
- 키움 API 호출은 특히 신중하게
- 의미 있는 에러 메시지 제공

## 키움 API 관련

### OpenAPI 참조 (필수)
프로그램 수정 시 반드시 `openapi` 폴더(키움 설치 폴더)를 참조할 것

#### 공식 문서 위치
- **키움 Open API 설치 경로**: `C:\OpenAPI\`
- **개발 가이드 XML**: `C:\OpenAPI\koa_devguide.xml`
- **프로젝트 설치 가이드**: `auto_trading\docs\installation\KIWOOM_API_SETUP.md`

#### 프로그램 수정 시 필수 확인 사항
1. **TR 코드 사용**: `koa_devguide.xml`에서 TR 명세 확인 (입력/출력 필드)
2. **API 제한**: 초당 5건, 일일 1,000건 제한 준수
3. **비밀번호 처리**: 모의투자는 비밀번호 필드 생략 가능
4. **에러 처리**: SendOrder, CommRqData 반환값 체크 필수
5. **화면번호**: 중복되지 않게 4자리 숫자 사용 (0000~9999)

#### 현재 사용 중인 TR 코드
- **OPW00001**: 예수금상세현황요청 (계좌 잔고 조회)
- **OPW00018**: 계좌평가잔고내역요청 (보유 종목 조회)
- **OPT10001**: 주식기본정보요청 (현재가 조회)
- **OPT10023**: 거래량상위요청 (거래대금 상위 종목 조회, 급등주 감지용)

#### API 함수 사용 패턴
```python
# TR 조회 표준 패턴
self._wait_for_request()  # API 제한 준수
self.ocx.dynamicCall("SetInputValue(QString, QString)", "입력필드", "값")
ret = self.ocx.dynamicCall("CommRqData(...)")
if ret == 0:  # 성공
    self.request_event_loop.exec_()

# 주문 표준 패턴
self._wait_for_order()  # 주문 제한 준수
ret = self.ocx.dynamicCall("SendOrder(...)")
if ret == 0:  # 성공
    log.success("주문 전송 성공")
```

### API 호출 제한
- 초당 5건 제한 (0.2초 간격)
- 일일 조회 한도: 1,000건
- 반드시 `_wait_for_request()` 사용

### 실시간 데이터
- 콜백 함수로 처리
- 메인 스레드 블로킹 방지
- QApplication 이벤트 루프 필수

## 매매 전략

### 신호 생성
- 최소 30개 이상의 가격 데이터 필요
- 3개 전략 중 2개 이상 동의 시 실행
- 신호 강도 계산 및 로깅

### 리스크 관리
- 손절매: -5% (기본값)
- 익절매: +10% (기본값)
- 포지션 크기: 계좌의 10%
- 일일 손실 한도: 3%
- 최대 보유 종목: 3개

## 테스트

### 단위 테스트
- 각 모듈별 테스트 작성
- `pytest` 사용
- 키움 API는 Mock 객체 사용

### 통합 테스트
- 모의투자 환경에서만
- 소액(1주)으로 테스트
- 최소 1주일 이상 검증

## Git 관리

### 커밋 메시지
```
feat: 새로운 기능 추가
fix: 버그 수정
docs: 문서 수정
refactor: 코드 리팩토링
test: 테스트 추가
chore: 빌드 설정 등
```

### 제외 파일 (.gitignore)
- `.env` - 환경 변수
- `.venv/` - 가상환경
- `logs/` - 로그 파일
- `__pycache__/` - Python 캐시
- `*.pyc` - 컴파일된 Python 파일

## 보안

### 절대 금지
- 계좌번호, 비밀번호 하드코딩
- `.env` 파일 Git 커밋
- 실계좌에서 테스트
- API 키/토큰 노출

### 권장 사항
- 모의투자로 충분히 테스트
- 로그에도 민감 정보 마스킹
- 정기적인 보안 점검

## 개발 워크플로우

### 1. 환경 설정
```powershell
# 가상환경 활성화
.\.venv\Scripts\Activate.ps1

# 패키지 설치
pip install -r auto_trading/requirements.txt
```

### 2. 개발
```powershell
# 작업 폴더로 이동
cd auto_trading

# 코드 작성
# ...

# 테스트
python -m pytest
```

### 3. 실행
```powershell
# 설정 확인
python -c "from config import Config; Config.print_config()"

# 프로그램 실행
python main.py
```

## 문서화

### 필수 문서
- `README.md` - 전체 사용 설명서
- `QUICKSTART.md` - 빠른 시작 가이드
- `KIWOOM_API_SETUP.md` - API 신청 가이드
- `STRATEGY_GUIDE.md` - 전략 설명

### 코드 주석
- 복잡한 로직은 반드시 주석 추가
- 함수/클래스에 Docstring 작성
- 매개변수와 반환값 명시

## 성능 최적화

### 데이터 처리
- pandas DataFrame 효율적 사용
- 불필요한 복사 최소화
- 메모리 사용량 모니터링

### 실시간 처리
- 이벤트 기반 아키텍처
- 블로킹 작업 최소화
- 적절한 캐싱 전략

## 배포

### 체크리스트
- [ ] .env 파일 설정 확인
- [ ] 키움 API 설치 확인
- [ ] 모의투자 계좌 준비
- [ ] 로그 디렉토리 생성
- [ ] 테스트 실행 및 검증

## 문제 해결

### 일반적인 이슈
1. 인코딩 문제: `chcp 65001` (UTF-8)
2. 가상환경 활성화: PowerShell 실행 정책 확인
3. 키움 API: Windows 전용, COM 객체 사용
4. 로그인 실패: 공동인증서 확인

## 참고 자료
- 키움 Open API 매뉴얼: KOA Studio 참고
- Python-dotenv: https://pypi.org/project/python-dotenv/
- Loguru: https://loguru.readthedocs.io/
- PyQt5: https://www.riverbankcomputing.com/software/pyqt/










